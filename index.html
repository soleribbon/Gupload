<!DOCTYPE html>
<html>
  <head>

    <link rel="stylesheet" type="text/css" href="style.css">

    <meta charset="UTF-8">
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
 
    <title>Gupload</title>
   
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">

  </head>
  <body id="body">
    

    <div id="draggablearea" class="draggablearea">

     
        <div class="logo_text_select">


          <div id="checkmark">

            <?xml version="1.0" encoding="UTF-8" standalone="no"?>
            <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
            <svg width="100" height="50" viewBox="0 0 980 710" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
                <path d="M167.2,542.7L0,375.5L32.7,342.7L65.5,310L335,579.5L914.5,0L980,65.5L657.7,387.8C480.5,565 335.3,710 335,710C334.7,710 259.2,634.7 167.2,542.7Z" style="fill:rgb(27,145,1);fill-rule:nonzero;"/>
            </svg>



          </div>

          <div id="images">

            <div id="upload-image">
              <?xml version="1.0" encoding="utf-8"?>
              <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
              <svg id="cloud" version="1.0" xmlns="http://www.w3.org/2000/svg" width="100px" height="87px" viewBox="0 0 300 260" preserveAspectRatio="xMidYMid meet">
              <g fill="#000000">
                <path d="M147.5 254.8 c-0.3 -0.7 -0.6 -31 -0.8 -67.3 l-0.2 -65.9 -19.7 18.7 c-10.8 10.3 -20.4 18.7 -21.1 18.7 -0.8 0 -1.8 -0.8 -2.2 -1.7 -0.7 -1.9 -0.6 -2 29.8 -30.8 8.7 -8.3 16.2 -15 16.7 -15 0.8 0 9.6 8.2 41 38.2 6 5.8 6.4 6.3 4.9 7.9 -1.1 1.1 -2.2 1.3 -3.2 0.8 -0.8 -0.5 -10 -8.9 -20.3 -18.8 l-18.9 -17.8 -0.5 66.8 c-0.3 36.8 -0.6 67 -0.8 67.2 -0.7 0.8 -4.3 0 -4.7 -1z"/>
                <path d="M54 200 c-14.6 -1.9 -25.4 -7.3 -36.1 -18 -8.2 -8.1 -13.5 -17.4 -15.9 -27.9 -1.8 -7.8 -0.8 -23.1 2 -30.6 6 -15.7 18.2 -28.2 33.9 -34.5 l6.4 -2.6 0.3 -9 c1.3 -36.5 28 -67 65.6 -74.9 9.3 -2 26.3 -2 35.3 -0.1 26.1 5.5 47.5 22 58.1 44.6 1.9 4.1 3.9 8.2 4.3 9 0.6 1.1 2 1.3 5.2 1 16.6 -1.8 31.4 0.8 46.2 8.2 16.9 8.5 29.3 22.5 36.3 41 2.6 6.7 2.8 8.4 2.9 21.8 0 16.3 -0.8 19.7 -7.8 33.5 -3.1 6.1 -6.2 10.1 -12.7 16.6 -7.3 7.2 -10.2 9.3 -19.1 13.7 -10.7 5.3 -18.4 7.5 -30.1 8.7 -6.4 0.6 -6.8 0.5 -7.7 -1.7 -0.5 -1.3 -4.6 -31.8 -9.1 -67.7 -4.4 -36 -8.2 -65.7 -8.5 -65.9 -0.2 -0.2 -4.8 0.3 -10.2 1.2 -18.6 3 -140.8 24 -141.1 24.2 -0.5 0.3 3.5 16.5 16 64.3 5.9 22.7 10.8 42.2 10.8 43.1 0 1 -0.7 2.1 -1.6 2.4 -2 0.8 -16.4 0.5 -23.4 -0.4z m14.3 -22.2 c-5.9 -22.6 -16.3 -61.5 -20.1 -74.8 -3.3 -12 -2.9 -11.8 -12.7 -6.8 -21.2 10.8 -33.1 34.6 -28.1 56.1 2.6 11.1 6.2 17.4 14.5 25.8 11.8 11.8 24 16.7 42.3 16.8 l8.6 0.1 -4.5 -17.2z m177.4 13.7 c11.1 -3.5 19.9 -8.9 28.9 -17.9 6.5 -6.5 8.9 -9.8 12.2 -16.6 9.3 -19.4 9.3 -37.2 0 -57 -7.7 -16.3 -25.7 -30.7 -44.8 -35.7 -6.1 -1.7 -31.1 -2.6 -32.3 -1.3 -0.3 0.4 15.4 128.3 16.2 131.8 0.2 1 13.4 -1.3 19.8 -3.3z m-128.3 -118.1 c87.8 -15.3 84.2 -14.5 83.8 -17.4 -0.1 -1.3 -1.6 -5 -3.3 -8.3 -9.3 -18.4 -25.9 -31.8 -47.4 -38.3 -7.7 -2.3 -10.9 -2.7 -22 -2.8 -13.8 0 -20 1.1 -31.7 5.8 -23.6 9.5 -40.7 30.1 -45.4 54.4 -1.4 7.5 -1.9 18.2 -0.8 18.2 0.4 0 30.4 -5.2 66.8 -11.6z"/>
              </g>
              </svg>


            </div>

            <img id="loading-gif" src="images/loading.gif" alt="Loading..." />

          </div>
    
          <p id="draganddrop_text">Drag and Drop</p>
      
    
          <form class="my-form" id="select-files">
    
            <label for="file-upload" class="custom-file-upload">
              <i class="fa fa-cloud-upload"></i> Select Files
            </label>
            <input id="file-upload" type="file" multiple/>
      
            <!-- onchange="handleInputClick(this)" -->
          </form>

          <progress id="progress" value="0"></progress>
          <div id="file_list"></div>
  
          <br>
          <button id="copyButton">Copy Link</button> 
          <div id="bottom-row">
            <button onclick="restart()"  id="restartButton">New Upload</button>
            <button id="viewFilesButton">View Files</button>
            
          </div>

        </div>

    </div>
    
    <br>
    <br>
    <br>
    <p id="quit" onclick="quit()">quit</p>
    <p id="version"></p>
    <script>
    
      const { ipcRenderer } = require('electron');
     
      
      ipcRenderer.send('app_version');
      ipcRenderer.on('app_version', (event, arg) => {
        ipcRenderer.removeAllListeners('app_version');
        version.innerText = 'v' + arg.version;
        
      });
    </script>
    
    <p id="selected_server"></p>

    <!-- IF I WANT TO EVER MAKE AN IN-APP UPDATE MESSAGE -->
    <!-- 
    <div id="notification" class="hidden">
      <p id="message"></p>
      <button id="close-button" onClick="closeNotification()">
        Close
      </button>
      <button id="restart-button" onClick="restartApp()" class="hidden">
        Restart and Install
      </button>
    </div> -->

    <script>


// FOR EXPIREMENTING WITH DISPLAY UPDATES
    // const { ipcRenderer } = require('electron')

    // //start by checking if update available
    // const notification = document.getElementById('notification');
    // const message = document.getElementById('message');
    // const restartButton = document.getElementById('restart-button');
    // ipcRenderer.on('update_available', () => {
    //   ipcRenderer.removeAllListeners('update_available');
    //   message.innerText = 'A new update is available. Downloading now...';
    //   console.log("NEW UPDATE AVAILABLE - DOWNLOADING NOW")
    //   notification.classList.remove('hidden');
    // });

    // ipcRenderer.on('checking-for-update', () => {
     
    //   message.innerText = 'A new update is available. Downloading now...';
    //   console.log("CHECKING FOR UPDATES....")
    //   notification.classList.remove('hidden');
    // });

    // ipcRenderer.on('update_downloaded', () => {
    //   ipcRenderer.removeAllListeners('update_downloaded');
    //   message.innerText = 'Update Downloaded. It will be installed on restart. Restart now?';
    //   console.log("UPDATE DOWNLOADED")
    //   restartButton.classList.remove('hidden');
    //   notification.classList.remove('hidden');
    // });

    // function closeNotification() {
    //   notification.classList.add('hidden');
    // }
    // function restartApp() {
    //   ipcRenderer.send('restart_app');
    // }

    
    restart()
    let server;
    let server_response;
    let folderId; //for multiple file uploads
    let guestToken;


    function quit(){
      
      window.close()

    }

    //find server on app load
  
    const Http = new XMLHttpRequest();
    const url='https://apiv2.gofile.io/getServer';
    Http.open("GET", url);
    Http.send();
    

    Http.onreadystatechange = function(){
      
      if(this.readyState==4 && this.status==200){
        console.log(Http.responseText)
        let parsed = JSON.parse(Http.responseText)

        server_response = parsed["data"]

        server = document.getElementById("selected_server").innerHTML = server_response.server;


      }
      

    };

    //----------------------------------
    const fileInput = document.querySelector("#file-upload");


    //MAIN UPLOAD FILE FUNCTION
    const uploadFile = (file, folderId, guestToken, isMultiple, i) => {

      if (isMultiple){
        //don't display anything

      }else{
        document.getElementById("draganddrop_text").innerHTML = "Uploading file...";
        document.getElementById("loading-gif").style.display = "block";
        document.getElementById("upload-image").style.display = "none";
        document.getElementById("select-files").style.display = "none";
        document.getElementById("progress").style.visibility = "visible";
        document.getElementById("progress").style.display = "inline";

      }

      const API_ENDPOINT = "https://"+server+".gofile.io/uploadFile";
      const request = new XMLHttpRequest();
      const formData = new FormData();
      request.open("POST", API_ENDPOINT);


      var progressBar = document.getElementById("progress");

      request.upload.onprogress = function(e) {
        if (e.lengthComputable) {
          progressBar.max = e.total;
          progressBar.value = e.loaded;
        }
      }

      request.upload.onloadstart = function(e) {
        progressBar.value = 0;
    
      }

      request.upload.onloadend = function(e) {
        progressBar.value = e.loaded;
      
       
      }

      request.onreadystatechange = () => {

        if (request.readyState === 4 && request.status === 200) {

          console.log(request.responseText);
          let parsedCode = JSON.parse(request.responseText);
          let code = parsedCode["data"]["code"]; //for specific upload
          let link = "gofile.io/d/"+code;



          if (isMultiple){
            //don't display anything

          }else{

            document.getElementById("loading-gif").style.display = "none"; //hide loading gif
            document.getElementById("restartButton").style.display = "table-cell";
            document.getElementById("viewFilesButton").style.display = "table-cell"; //display restart
            document.getElementById("draganddrop_text").innerHTML = "<p id='link'>"+link+"</p>";

            let full_link = "https://"+link;
            document.getElementById("viewFilesButton").setAttribute('onclick', 'require("electron").shell.openExternal("'+full_link+'")');


            document.getElementById("progress").style.visibility = "hidden";

            document.getElementById("checkmark").style.display = "inline";
            //copy button handler
            document.getElementById("copyButton").style.display = "block";
            document.getElementById("copyButton").addEventListener("click", function() {
              copyToClipboard(link);
              document.getElementById("copyButton").innerHTML = "Link Copied!";
              document.getElementById("copyButton").style.backgroundColor = "#CEE8BA "; 
              var timeout;
              clearTimeout(timeout);
              timeout = setTimeout(function() {
                document.getElementById("copyButton").innerHTML = "Copy Link";
                document.getElementById("copyButton").style.backgroundColor = "white";             
              }, 3000);
            });


          }

          
        }else if (isMultiple && request.status === 200){ //for multiples, only a 200 status code is returned, not a 4 request complete...
          
          //don't display anything 

        }else if (request.status === 500){
          document.getElementById("draganddrop_text").innerHTML = "Error: Server updating. Please try again later.";
          document.getElementById("loading-gif").style.display = "none";
          document.getElementById("restartButton").style.display = "table-cell";
          document.getElementById("progress").style.visibility = "hidden";
          document.getElementById("viewFilesButton").style.display = "none";
          document.getElementById("copyButton").style.display = "none";
          document.getElementById("checkmark").style.display = "none";


        }else{
          document.getElementById("draganddrop_text").innerHTML = "Error Occured.";
          document.getElementById("loading-gif").style.display = "none";
          document.getElementById("restartButton").style.display = "table-cell";
          document.getElementById("progress").style.visibility = "hidden";
          document.getElementById("viewFilesButton").style.display = "none";
          document.getElementById("copyButton").style.display = "none";
          document.getElementById("checkmark").style.display = "none";

        }
      };
      formData.append("file", file);

      if (isMultiple){
        formData.append("folderId", folderId);
        formData.append("token", guestToken);
     
        

      }

      request.send(formData);
    }; //END OF uploadFile()


    //-----------ONLY FOR MULTIPLE FILE UPLOADS--------------
    const uploadFirstFile = (all_files, file, fileCount) => {

      var progressBar = document.getElementById("progress");

      progressBar.style.display = "inline";
      progressBar.style.visibility = "visible";

      
      const API_ENDPOINT = "https://"+server+".gofile.io/uploadFile";
      const request = new XMLHttpRequest();


      const formData = new FormData();
      request.open("POST", API_ENDPOINT, true); //ASYNC SETTING


      request.upload.onprogress = function(e) {
        if (e.lengthComputable) {
          progressBar.max = e.total;
          progressBar.value = e.loaded;
        }
      }

      request.upload.onloadstart = function(e) {
        progressBar.value = 0;
      }

      request.upload.onloadend = function(e) {
        progressBar.value = e.loaded;
      
       
      }

      request.onreadystatechange = () => {


        if (request.readyState === 4 && request.status === 200) {



          console.log(request.responseText);

          let parsedCode = JSON.parse(request.responseText);

          //console.log(parsedCode); //DELETE WHEN FINAL

          let code = parsedCode["data"]["code"]; //for specific upload
          folderId = parsedCode["data"]["parentFolder"];
          guestToken = parsedCode["data"]["guestToken"];

          
          let link = "gofile.io/d/"+code;

            for (var i = 1; i < fileCount; i++){

              uploadFile(all_files[i], folderId, guestToken, true, i); //true in this case is for the variable "isMultiple"
               
            }
            document.getElementById("loading-gif").style.display = "none"; //hide loading gif
            document.getElementById("restartButton").style.display = "table-cell";
            document.getElementById("viewFilesButton").style.display = "table-cell";


            document.getElementById("draganddrop_text").innerHTML = "<p id='link'>"+link+"</p>";

            let full_link = "https://"+link;
            document.getElementById("viewFilesButton").setAttribute('onclick', 'require("electron").shell.openExternal("'+full_link+'")');

            progressBar = document.getElementById("progress");
            progressBar.style.display = "none"; 

            document.getElementById("checkmark").style.display = "inline";

            //copy button handler
            document.getElementById("copyButton").style.display = "block";

            document.getElementById("copyButton").addEventListener("click", function() {
              copyToClipboard(link);
              document.getElementById("copyButton").innerHTML = "Link Copied!";
              document.getElementById("copyButton").style.backgroundColor = "#CEE8BA "; 
              var timeout;
              clearTimeout(timeout);
              timeout = setTimeout(function() {
                document.getElementById("copyButton").innerHTML = "Copy Link";  
                document.getElementById("copyButton").style.backgroundColor = "white";           
              }, 3000);
            });
          
        }else if (request.status === 500){
          document.getElementById("draganddrop_text").innerHTML = "Error: Server updating. Please try again later.";
          document.getElementById("loading-gif").style.display = "none";
          document.getElementById("restartButton").style.display = "table-cell";
          document.getElementById("progress").style.visibility = "hidden";
          document.getElementById("viewFilesButton").style.display = "none";
          document.getElementById("copyButton").style.display = "none";
          document.getElementById("checkmark").style.display = "none";


        }else{
          document.getElementById("draganddrop_text").innerHTML = "Error Occured.";
          document.getElementById("loading-gif").style.display = "none";
          document.getElementById("restartButton").style.display = "table-cell";
          document.getElementById("progress").style.visibility = "hidden";
          document.getElementById("viewFilesButton").style.display = "none";
          document.getElementById("copyButton").style.display = "none";
          document.getElementById("checkmark").style.display = "none";

        }
      };
     
      formData.append("file", file); //we don't set admin code because this initial upload doesn't need an admin code
      request.send(formData);
      
      }; //END OF uploadFirstFile()



      let dropArea = document.getElementById('draggablearea')
      

      ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        

         dropArea.addEventListener(eventName, preventDefaults, false)

      })

      function preventDefaults (e) {

        e.preventDefault()
        e.stopPropagation()
      }

      ;['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false)
        


      })

      ;['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false)
      })

      function highlight(e) {

        dropArea.classList.add('highlight');
        document.getElementById("select-files").style.display = "none";
        document.getElementById("copyButton").style.display = "none";
        document.getElementById("restartButton").style.display = "none";
        document.getElementById("viewFilesButton").style.display = "none";


        document.getElementById("draganddrop_text").style.display = "none"
        document.getElementById("cloud").setAttribute("style","opacity:0.5; -moz-opacity:0.5; filter:alpha(opacity=50)");

        document.getElementById("checkmark").style.display = "none";

        document.getElementById("file_list").style.display = "none";

      }

      function unhighlight(e) {
        dropArea.classList.remove('highlight')
        document.getElementById("select-files").style.display = "block";
        document.getElementById("draganddrop_text").innerHTML = "Drag and Drop";
        document.getElementById("draganddrop_text").style.display = "block"
        document.getElementById("cloud").removeAttribute("style","opacity:0.5;");
        document.getElementById("upload-image").style.display = "block";

      }


      let all_files;
      let files;
      let file_list_div;
      let fileCount;
  

      fileInput.addEventListener("change", event => {
        restart()
        all_files = event.target.files;
       

        if (event.target.files.length<1){ //"CANCEL" button handler
          restart();
          exit(0);

          
        }
        files = event.target.files[0];

        file_list_div = document.getElementById("file_list")
        file_list_div.style.display = "block"; // show filelist div

        for (let w = 0; w<all_files.length; w++){
          //console.log(all_files[w].name);
          var element = document.createElement('p');
          element.className = "filelist";
          element.innerHTML = ("<b>"+(w+1+". ")+"</b>" + all_files[w].name);
          file_list_div.appendChild(element);

        }

        fileCount = event.target.files.length;
        
        if (fileCount > 1){  //if multiple files

          document.getElementById("draganddrop_text").innerHTML = "Uploading files...";
          document.getElementById("loading-gif").style.display = "block";
          document.getElementById("upload-image").style.display = "none";
          document.getElementById("select-files").style.display = "none";
          document.getElementById("viewFilesButton").style.display = "none";

          uploadFirstFile(all_files, files, fileCount); 
    
          
        }else{
          //just one file
          folderId = "random";
          uploadFile(files, folderId, false);

        }

      });    

      dropArea.addEventListener('drop', function(e){
        restart();


        all_files = e.dataTransfer.files;
        files = e.dataTransfer.files[0];


        file_list_div = document.getElementById("file_list")
        file_list_div.style.display = "block"; // show filelist div

        for (let w = 0; w<all_files.length; w++){
          //console.log(all_files[w].name);
          var element = document.createElement('p');
          element.className = "filelist";
          element.innerHTML = ("<b>"+(w+1+". ")+"</b>" + all_files[w].name);
          file_list_div.appendChild(element);

        }

        fileCount = e.dataTransfer.files.length;
        
        if (fileCount > 1){ 

          //multiple files
          folderId = "samplesamplesample";
          //now that we have the admin code variable set, each upload will contain the same admin code until it is reset manually
        

          //adminCode = uploadFirstFile(event.target.files[0], adminCode); //first upload (1 file) returns admin code - we don't need that last "isMultiple" parameter because it's a different function


          document.getElementById("draganddrop_text").innerHTML = "Uploading files...";
          document.getElementById("progress").style.display = "block";
          document.getElementById("loading-gif").style.display = "block";
          document.getElementById("upload-image").style.display = "none";
          document.getElementById("select-files").style.display = "none";
          document.getElementById("viewFilesButton").style.display = "none";



          document.getElementById("progress").style.display = "inline";
          uploadFirstFile(all_files, files, fileCount);
              
          
        }else{
          //just one file
          adminCode = "random";
          uploadFile(files, adminCode, false);
        }
        
        
      });

      function restart(){

        document.getElementById("draganddrop_text").innerHTML = "Drag and Drop";
        document.getElementById("restartButton").style.display = "none";
        document.getElementById("loading-gif").style.display = "none";
        document.getElementById("select-files").style.display = "block";
        document.getElementById("upload-image").style.display = "block";
        document.getElementById("copyButton").style.display = "none";
        document.getElementById("viewFilesButton").style.display = "none";

        let filelist = document.getElementById("file_list");
        filelist.innerHTML = "";
        filelist.style.display = "none";

        document.getElementById("progress").style.visibility = "hidden";
        document.getElementById("checkmark").style.display = "none";


      }


      const copyToClipboard = str => {
        const el = document.createElement('textarea');
        el.value = str;
        el.setAttribute('readonly', '');
        el.style.position = 'absolute';
        el.style.left = '-9999px';
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);


      };

    </script>

    <!-- You can also require other files to run in this process -->
    <script src="./renderer.js"></script>


  </body>
</html>
